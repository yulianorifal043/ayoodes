<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Layanan Warga - Portal Administrasi Desa Digital</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    
    <!-- Custom Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563EB', // Biru Resmi
                        secondary: '#F0F9FF', // Biru Muda untuk background
                    },
                },
            },
        }
    </script>
    
    <!-- Load Custom Styles (untuk layout) -->
    <link rel="stylesheet" href="assets/css/styles.css">
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="antialiased bg-secondary min-h-screen">
    
    <!-- Notification Container (Untuk pesan sistem) -->
    <div id="notification-container" class="fixed right-4 top-4 z-50 space-y-2">
        <!-- Notifikasi akan muncul di sini -->
    </div>

    <!-- Header / Navbar Minimal -->
    <header class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
            <div class="flex justify-between items-center">
                <!-- Logo & Judul -->
                <a href="index.html" class="flex items-center space-x-2 text-xl font-extrabold text-gray-900">
                    <img src="assets/images/logo-desa.png" alt="Logo Desa Digital" class="w-9 h-9">
                    <span>Layanan Desa</span>
                </a>

                <!-- Navigasi Cepat -->
                <div class="space-x-4">
                    <a href="informasi_desa.html" class="text-gray-600 hover:text-primary transition duration-150 text-sm md:text-base">
                        <i data-lucide="map" class="w-5 h-5 inline-block mr-1 align-sub"></i> Info Desa
                    </a>
                    <a href="index.html" class="text-red-600 hover:text-red-800 transition duration-150 text-sm md:text-base">
                        <i data-lucide="log-out" class="w-5 h-5 inline-block mr-1 align-sub"></i> Keluar
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="py-12 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto">
        <div class="text-center mb-10">
            <h1 class="text-3xl lg:text-4xl font-extrabold text-gray-900">Portal Pengajuan Layanan Administrasi</h1>
            <p class="mt-2 text-lg text-gray-600">Lakukan verifikasi NIK Anda untuk mengakses layanan.</p>
            <p class="mt-1 text-lg text-green-600">Gunakan NIK ini untuk ujicoba 3201011205800001</p>
        </div>

        <!-- Progress Bar (Wizard) -->
        <div class="max-w-4xl mx-auto mb-10">
            <div class="flex justify-between items-center relative">
                <div id="progress-bar" class="absolute h-1 bg-primary transition-all duration-500" style="width: 0%; top: 50%; transform: translateY(-50%); z-index: 1;"></div>
                
                <div id="step-1" class="step-circle bg-primary text-white z-20">1</div>
                <div id="step-2" class="step-circle bg-gray-300 text-gray-700 z-20">2</div>
                <div id="step-3" class="step-circle bg-gray-300 text-gray-700 z-20">3</div>
            </div>
            <div class="flex justify-between mt-2 text-sm text-gray-600">
                <span id="label-1" class="text-primary font-semibold">Verifikasi NIK</span>
                <span id="label-2">Pertanyaan Kunci</span>
                <span id="label-3">Pilih Layanan</span>
            </div>
        </div>

        <!-- Wizard Content -->
        <div class="bg-white p-6 sm:p-10 rounded-xl shadow-2xl max-w-4xl mx-auto">
            
            <!-- Stage 1: Verifikasi NIK -->
            <div id="stage-nik">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Tahap 1: Masukkan NIK Anda</h2>
                <p class="mb-4 text-gray-600">Masukkan Nomor Induk Kependudukan (NIK) Anda untuk pengecekan status di sistem Desa Digital.</p>
                <input type="text" id="input-nik" placeholder="Contoh: 3201xxxxxxxxxxxxxx" maxlength="16" class="w-full border-gray-300 rounded-xl shadow-sm p-3 focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50">
                <button onclick="checkNIK()" class="mt-6 bg-primary text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-700 transition duration-300 w-full">
                    Verifikasi NIK
                </button>
            </div>

            <!-- Stage 2: Pertanyaan Kunci (Keamanan) -->
            <div id="stage-question" class="hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Tahap 2: Verifikasi Keamanan</h2>
                <div id="question-area" class="bg-gray-50 p-6 rounded-xl border border-dashed border-gray-300 mb-6">
                    <p class="text-lg font-semibold mb-3 text-gray-700" id="security-question">Pertanyaan:</p>
                    <p class="text-lg font-semibold mb-3 text-gray-700" id="security-question">Kepala Des-> Joko Widodo, Ketua RT -> Slamet, BUMDes-> Maju Bersama</p>
                    <input type="text" id="answer-input" placeholder="Masukkan jawaban Anda di sini" class="w-full border-gray-300 rounded-xl shadow-sm p-3 focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50">
                    <span id="hint-text" class="text-sm text-red-500 mt-2 block"></span>
                </div>
                <button onclick="submitAnswer()" class="bg-green-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-green-700 transition duration-300 w-full">
                    Kirim Jawaban & Lanjut
                </button>
                <button onclick="setStage(1)" class="mt-4 text-sm text-gray-500 hover:text-primary w-full text-center">
                    Batal dan Masukkan NIK Lain
                </button>
            </div>
            
            <!-- Stage 3: Pilih Layanan (Tabs) -->
            <div id="stage-tabs" class="hidden">
                <div id="sensus-alert" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 mb-6 rounded-lg">
                    <p class="font-bold inline-flex items-center"><i data-lucide="alert-triangle" class="w-5 h-5 mr-2"></i> Perhatian!</p>
                    <p class="text-sm mt-1">Sistem mendeteksi NIK Anda belum terdata lengkap. Harap lengkapi data kependudukan Anda saat mengisi formulir pengajuan layanan.</p>
                </div>
                
                <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-3">Tahap 3: Pilih Jenis Layanan</h2>

                <!-- Tabs Navigation -->
                <div class="flex space-x-1 border-b mb-6 overflow-x-auto">
                    <button class="tab-button active-tab" onclick="openTab(event, 'kependudukan')">
                        <i data-lucide="users" class="w-4 h-4 mr-2"></i> Kependudukan
                    </button>
                    <button class="tab-button" onclick="openTab(event, 'izin-usaha')">
                        <i data-lucide="briefcase" class="w-4 h-4 mr-2"></i> Surat Izin Usaha
                    </button>
                    <button class="tab-button" onclick="openTab(event, 'lainnya')">
                        <i data-lucide="scroll-text" class="w-4 h-4 mr-2"></i> Surat Pengantar Lainnya
                    </button>
                </div>

                <!-- Tab Content 1: Kependudukan -->
                <div id="kependudukan" class="tab-content">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700">Layanan Kependudukan</h3>
                    <div class="space-y-4">
                        <div class="p-4 bg-gray-50 border rounded-xl hover:shadow-md transition duration-200">
                            <h4 class="font-bold text-lg text-gray-900">Pengajuan KTP Baru / Perubahan Data</h4>
                            <p class="text-sm text-gray-600 mt-1">Mengurus KTP pertama kali, hilang, atau ada perubahan data.</p>
                            <button class="mt-3 bg-blue-500 text-white px-4 py-1.5 rounded-lg text-sm hover:bg-blue-600">Ajukan</button>
                        </div>
                        <div class="p-4 bg-gray-50 border rounded-xl hover:shadow-md transition duration-200">
                            <h4 class="font-bold text-lg text-gray-900">Pembaruan Kartu Keluarga (KK)</h4>
                            <p class="text-sm text-gray-600 mt-1">Penambahan, pengurangan anggota, atau perubahan status KK.</p>
                            <button class="mt-3 bg-blue-500 text-white px-4 py-1.5 rounded-lg text-sm hover:bg-blue-600">Ajukan</button>
                        </div>
                    </div>
                </div>

                <!-- Tab Content 2: Izin Usaha -->
                <div id="izin-usaha" class="tab-content hidden">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700">Layanan Surat Izin Usaha</h3>
                    <div class="p-4 bg-gray-50 border rounded-xl">
                        <h4 class="font-bold text-lg text-gray-900">Surat Keterangan Usaha (SKU)</h4>
                        <p class="text-sm text-gray-600 mt-1">Diperlukan untuk mengajukan kredit bank atau perizinan lanjutan.</p>
                        <button class="mt-3 bg-blue-500 text-white px-4 py-1.5 rounded-lg text-sm hover:bg-blue-600">Ajukan</button>
                    </div>
                </div>

                <!-- Tab Content 3: Lainnya -->
                <div id="lainnya" class="tab-content hidden">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700">Surat Pengantar Lainnya</h3>
                    <div class="p-4 bg-gray-50 border rounded-xl">
                        <h4 class="font-bold text-lg text-gray-900">Surat Pengantar Kematian</h4>
                        <p class="text-sm text-gray-600 mt-1">Diperlukan untuk pengurusan akta kematian.</p>
                        <button class="mt-3 bg-blue-500 text-white px-4 py-1.5 rounded-lg text-sm hover:bg-blue-600">Ajukan</button>
                    </div>
                </div>
            </div>
            
        </div>
    </main>

    <!-- Footer -->
    <footer class="mt-12 py-6 text-center text-sm text-gray-600 border-t">
        &copy; 2025 Desa Digital. Layanan Administrasi Online.
    </footer>

    <!-- Custom Script for Service Workflow -->
    <script>
        // --- FUNGSI CORE (Diulang untuk menjamin fungsi di Canvas) ---
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            const color = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            }[type];
            
            const icon = {
                success: 'check-circle',
                error: 'x-circle',
                warning: 'alert-triangle',
                info: 'info'
            }[type];

            const notification = document.createElement('div');
            notification.className = `${color} text-white px-4 py-3 rounded-xl shadow-xl flex items-center space-x-2 max-w-xs transition-all duration-300 transform translate-x-full`;
            notification.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5 flex-shrink-0"></i><span>${message}</span>`;
            
            container.appendChild(notification);

            // Animate In
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 10);

            // Animate Out and Remove
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                notification.addEventListener('transitionend', () => notification.remove());
            }, 5000);
            
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }
        window.showNotification = showNotification;
        // --- AKHIR FUNGSI CORE ---
        
        let currentNIK = null;
        let isNIKRegistered = false;
        
        // Data Mock untuk Simulasi Pengecekan NIK dan Pertanyaan
        const mockData = {
            // NIK yang terdaftar (sudah ada di sistem)
            registeredNIK: ['3201011205800001', '3302020101950002'],
            // Kumpulan pertanyaan keamanan acak
            securityQuestions: [
                { q: "Siapa nama Kepala Desa Anda?", a: "Joko Widodo" },
                { q: "Siapa nama Ketua RT Anda (RT 003 / RW 002)?", a: "Slamet" },
                { q: "Apa nama BUMDes di desa ini?", a: "Maju Bersama" }
            ]
        };
        let currentQuestion = null;


        // Fungsi Pengaturan Tahap (Stage) Wizard
        function setStage(stageNumber) {
            const stages = ['stage-nik', 'stage-question', 'stage-tabs'];
            stages.forEach((id, index) => {
                const stageDiv = document.getElementById(id);
                const stepCircle = document.getElementById(`step-${index + 1}`);
                const stepLabel = document.getElementById(`label-${index + 1}`);
                const progressBar = document.getElementById('progress-bar');
                
                if (index + 1 === stageNumber) {
                    stageDiv.classList.remove('hidden');
                    stepCircle.classList.remove('bg-gray-300', 'text-gray-700');
                    stepCircle.classList.add('bg-primary', 'text-white');
                    stepLabel.classList.add('font-semibold', 'text-primary');
                } else {
                    stageDiv.classList.add('hidden');
                    if (index + 1 > stageNumber) {
                        stepCircle.classList.remove('bg-primary', 'text-white');
                        stepCircle.classList.add('bg-gray-300', 'text-gray-700');
                        stepLabel.classList.remove('font-semibold', 'text-primary');
                    }
                }
            });

            // Atur progress bar
            if (stageNumber === 1) progressBar.style.width = '0%';
            if (stageNumber === 2) progressBar.style.width = '50%';
            if (stageNumber === 3) progressBar.style.width = '100%';
            
            // Atur status circle yang sudah terlewati
            for(let i = 1; i < stageNumber; i++) {
                document.getElementById(`step-${i}`).classList.remove('bg-gray-300', 'text-gray-700');
                document.getElementById(`step-${i}`).classList.add('bg-primary', 'text-white');
                document.getElementById(`label-${i}`).classList.add('font-semibold', 'text-primary');
            }
        }

        // Fungsi Verifikasi NIK (Tahap 1)
        function checkNIK() {
            const nik = document.getElementById('input-nik').value.trim();
            if (nik.length !== 16 || isNaN(nik)) {
                showNotification('NIK harus 16 digit angka yang valid.', 'error');
                return;
            }
            
            currentNIK = nik;
            isNIKRegistered = mockData.registeredNIK.includes(nik);

            if (isNIKRegistered) {
                showNotification('NIK terdaftar. Selamat datang!', 'success');
                // Langsung ke Tahap 3 (Layanan)
                document.getElementById('sensus-alert').classList.add('hidden'); // NIK terdaftar, tidak perlu sensus
                setStage(3); 
            } else {
                showNotification('NIK belum terdata lengkap. Lanjutkan verifikasi keamanan.', 'warning');
                // Lanjut ke Tahap 2 (Pertanyaan Kunci)
                setupSecurityQuestion();
                setStage(2);
            }
        }

        // Fungsi Menyiapkan Pertanyaan (Tahap 2)
        function setupSecurityQuestion() {
            const randomIndex = Math.floor(Math.random() * mockData.securityQuestions.length);
            currentQuestion = mockData.securityQuestions[randomIndex];
            
            document.getElementById('security-question').textContent = currentQuestion.q;
            document.getElementById('answer-input').value = '';
            document.getElementById('hint-text').textContent = 'Jawaban ini sensitif dan harus akurat.';
        }

        // Fungsi Memeriksa Jawaban (Tahap 2)
        function submitAnswer() {
            const answer = document.getElementById('answer-input').value.trim();
            const expectedAnswer = currentQuestion.a.trim();

            if (answer.toLowerCase() === expectedAnswer.toLowerCase()) {
                showNotification('Verifikasi keamanan berhasil. Anda dapat mengajukan layanan.', 'success');
                // Lanjut ke Tahap 3
                document.getElementById('sensus-alert').classList.remove('hidden'); // Tampilkan alert sensus
                setStage(3);
            } else {
                showNotification('Jawaban salah. Harap coba lagi atau hubungi perangkat desa.', 'error');
                document.getElementById('hint-text').textContent = 'Jawaban salah. Perhatikan penulisan (tidak harus kapital).';
            }
        }

        // Fungsi untuk Navigasi Tab (Tahap 3)
        function openTab(evt, tabName) {
            let i, tabcontent, tabbuttons;
            
            // Sembunyikan semua konten
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].classList.add('hidden');
            }

            // Hapus kelas aktif dari semua tombol
            tabbuttons = document.getElementsByClassName("tab-button");
            for (i = 0; i < tabbuttons.length; i++) {
                tabbuttons[i].classList.remove("active-tab");
            }

            // Tampilkan konten tab yang dipilih dan tandai tombol sebagai aktif
            document.getElementById(tabName).classList.remove('hidden');
            evt.currentTarget.classList.add('active-tab');
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Inisialisasi: Mulai dari Tahap 1
            setStage(1); 
            
            // Klik tombol pertama secara default saat tab dimuat
            const defaultButton = document.querySelector('.tab-button');
            if (defaultButton) {
                 // Tidak bisa langsung diklik karena hidden, tapi style aktif di setStage(1) sudah diatur
            }

            // Terapkan Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            // Tambahkan CSS untuk tombol tab custom
            const style = document.createElement('style');
            style.textContent = `
                .step-circle {
                    width: 32px;
                    height: 32px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: bold;
                    transition: background-color 0.3s, color 0.3s;
                }
                .tab-button {
                    @apply py-2 px-4 text-sm font-medium text-gray-600 hover:text-primary transition-colors duration-150 rounded-t-lg border-b-2 border-transparent;
                    white-space: nowrap; /* Mencegah wrap pada mobile */
                }
                .active-tab {
                    @apply text-primary border-primary font-semibold;
                }
            `;
            document.head.appendChild(style);
            
            showNotification('Selamat datang di Portal Layanan Warga. Silakan masukkan NIK Anda.', 'info');

            // Event listener untuk tombol Verifikasi NIK (agar tombol enter berfungsi)
            document.getElementById('input-nik').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') checkNIK();
            });
            
            // Event listener untuk tombol Submit Jawaban (agar tombol enter berfungsi)
            document.getElementById('answer-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') submitAnswer();
            });
            
        });
    </script>

    <!-- Load Admin Core Script (untuk showNotification, opsional jika Anda memisahkannya) -->
    <script src="assets/js/admin_core.js"></script>
</body>
</html>
